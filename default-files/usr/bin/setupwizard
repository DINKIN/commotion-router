#!/bin/ash

echo -e "\n\nWelcome to the configuration wizard.\n"

if [ `grep root /etc/shadow | cut -d ":" -f 2` == "x" ]; then
  echo "Please choose an administrator password: "
  passwd
fi

echo "Please enter new profile name: "

read PROFILE_NAME

commotion new $PROFILE_NAME

echo "Please enter mesh network name: "

read MESH_NAME

echo "Please select a valid channel: "

read MESH_CHANNEL

commotion set $PROFILE_NAME ssid $MESH_NAME

commotion set $PROFILE_NAME channel $MESH_CHANNEL

# generate bssid
BSSID=`commotion genbssid $MESH_NAME $MESH_CHANNEL`

# write changes to uci
WIRELESS_CONFIG=`uci add wireless wifi-iface`
uci rename wireless.$WIRELESS_CONFIG=commotionMesh

echo "Does this mesh network use encryption?"
  read answer                                                
  case $answer in                                            
    [Yy]*  ) echo "Please choose an encryption password: ";  
          read MESH_PASSWORD;                                
          commotion set $PROFILE_NAME key $MESH_PASSWORD; 
          uci set wireless.commotionMesh.encryption=psk2;
          uci set wireless.commotionMesh.key=$MESH_PASSWORD;
          break;;                                            
                                                             
    [Nn]* ) break;;                                          
    * ) echo "Please answer yes[y] or no[n]";;               
  esac 

# set wireless config
uci set wireless.commotionMesh.mode=adhoc
uci set wireless.commotionMesh.device=radio0
uci set wireless.$commotionMesh.network=$MESH_NAME
uci set wireless.$commotionMesh.ssid=$MESH_NAME

#uci set wireless.$MESH_NAME.bssid=$BSSID

uci set wireless.radio0.channel=$MESH_CHANNEL
uci set wireless.radio0.disabled=0



# set network config
uci add network.interface
uci rename network.interface
uci set network.$commotionMesh=interface
uci set network.$commotionMesh.class=mesh
uci set network.$commotionMesh.profile=$MESH_NAME
uci set network.$commotionMesh.proto=commotion


# set hostname


# set firewall




# commit profile changes
commotion save $PROFILE_NAME

# commit uci changes
uci commit



<<DESIGN

# Get AP name
read AP_NAME

# Create new wifi-iface and get resulting string
AP_CONFIG=`uci add wireless wifi-iface`

# Rename string to interface name
uci rename wireless.$AP_CONFIG=$AP_NAME

# Set default values
uci set wireless.$AP_NAME.network=lan
uci set wireless.$AP_NAME.mode=ap
uci set wireless.$AP_NAME.ssid=$AP_NAME
uci set wireless.$AP_NAME.device=radio0

# access point encryption

echo "Would you like to use encryption for the access point?"
  read answer                                                
  case $answer in                                            
    [Yy]*  ) echo "Please choose an encryption password for the AP: ";  
          read AP_PASSWORD;                                
             uci set wireless.$AP_NAME.encryption=psk2
             uci set wireless.$AP_NAME.key=$AP_PASSWORD
          break;;                                            
                                                             
    [Nn]* ) break;;  
            
    * ) echo "Please answer yes[y] or no[n]";;               
  esac 


# Commit changes
uci commit

DESIGN
