#!/bin/ash

# PRESET VALUES
SSID_MIN=1
SSID_MAX=31
KEY_MIN=8
KEY_MAX=63
CHANNEL_MIN=1
CHANNEL_MAX=12
HOSTNAME_MIN=2
HOSTNAME_MAX=24

# INPUT VALIDATOR
validate() {

  # check that user has not input empty string
  if [ -z "$3" ]; then
    echo "Invalid option."
    return 1;
  fi

  INPUT_STRING="$1"
  MIN_LENGTH="$2"
  MAX_LENGTH="$3"
  
  length=${#INPUT_STRING}
  if [ $length -lt $MIN_LENGTH -o $length -gt $MAX_LENGTH ]; then      
    echo "ERROR: Length invalid. Value must be between $MIN_LENGTH and $MAX_LENGTH characters."                         
    return 1;
  fi                                                            
                                                        
case $INPUT_STRING in                                                      
  *[^a-zA-Z0-9]* ) 
    echo "ERROR: Cannot assign non-ASCII characters.";
    return 1;;
  * ) 
    return 0;;
esac 
}

# RESET FUNCTION (for saved configurations)
clear_previous_configuration() {
  uci delete wireless.commotionMesh
  uci delete wireless.commotionAP
  uci delete network.commotionMesh
  # commotion delete $profile 
   
  uci commit wireless
}

# RESET FUNCTION (for unsaved configurations)
clear_values() {
  unset SETUP_RUN
  unset PASSWORD_SET
  unset HOSTNAME
  unset MESH_NAME
  unset CHANNEL
  unset MESH_PASSWORD
  unset AP_NAME
  unset AP_PASSWORD
  commotion delete $MESH_NAME
}

# GET CONFIGURATION VALUES FROM USER
get_config() {

# if setup_wizard file does not exist, create it
if [[ ! -f /etc/config/setup_wizard ]]; then
  touch /etc/config/setup_wizard
  
  # indicator for whether setup wizard has already run
  SETUP_RUN=`uci add setup_wizard settings`
  uci rename setup_wizard.$SETUP_RUN=settings
  uci set setup_wizard.settings.enabled=1
  
  # indicator for whether password has been set
  PASSWORD_SET=`uci add setup_wizard uci`
  uci rename setup_wizard.$PASSWORD_SET=passwords
  uci set setup_wizard.passwords.admin_pass=false
fi


# BEGIN USER INTERACTION
echo -e "\n\nWelcome to the Setup Wizard.\n"

# if password not set, require password set
while [ `grep root /etc/shadow | cut -d ":" -f 2` == "x" ]
do
  echo -e "\nPlease choose an administrator password: \n"
  passwd
  uci set setup_wizard.passwords.admin_pass=changed
done


while true; do
  echo -e "\n\nSet the hostname for this device? [y/n]"
  read answer
  case $answer in                                            
    [Yy]* ) while true; do
              echo "Enter new hostname: ";  
              read HOSTNAME;                                
              validate $HOSTNAME $HOSTNAME_MIN $HOSTNAME_MAX;
              if [ $? == 0 ]; then
                uci set system.@system[0].hostname="$HOSTNAME";
                break;
              fi
              done;
              break;;    
    [Nn]* ) break;;                                          
    * ) echo "Please answer yes[y] or no[n]";;               
  esac 
done



# GET MESH SETTINGS
while true; do
  echo -e "\n\nPlease enter mesh network name: "
  read MESH_NAME
  validate $MESH_NAME $SSID_MIN $SSID_MAX
  if [ $? == 0 ]; then
    break;
  fi
done

while true; do
  echo -e "\n\nPlease select a valid channel: "
  read CHANNEL
  if [ "$CHANNEL" -gt "$CHANNEL_MIN" ] && [ "$CHANNEL" -lt "$CHANNEL_MAX" ]; then
    break;
  else
    echo -e "ERROR: Channel must be between $CHANNEL_MIN and $CHANNEL_MAX";
  fi
done

echo -e "\nSet mesh network use encryption? [y/n]"
  while true; do
    read answer                                                
    case $answer in                                            
      [Yy]* ) while true; do
                echo "Please choose an encryption password: ";  
                read MESH_PASSWORD;
                validate $MESH_PASSWORD $KEY_MIN $KEY_MAX;
                if [ $? == "0" ]; then
                  break;
                fi
              done;
              break;;
      [Nn]* ) 
            break;;                                          
      * ) echo "Please answer yes[y] or no[n]";;               
    esac 
  done
  

# GET ACCESS POINT SETTINGS
echo -e "\n\nSet up an access point? [y/n]"
  while true; do
  read answer                                                
  case $answer in                                            
    [Yy]* ) while true; do
              echo -e "\nAccess point name: ";
              read AP_NAME;
              validate $AP_NAME $SSID_MIN $SSID_MAX;
              if [ $? == "0" ]; then
                break;
              fi
            done;
            break;;                                                                                        
    [Nn]* ) break;;
    * ) echo "Please answer yes[y] or no[n]";;               
  esac 
done

if [ $AP_NAME ]; then
  # access point encryption
  echo -e "\n\nSet encryption for the access point? [y/n]"
    while true; do
    read answer                                                
    case $answer in                                            
      [Yy]* ) while true; do
                echo -e "\nPlease choose an encryption password: ";  
                read AP_PASSWORD;                                
                validate $AP_PASSWORD $KEY_MIN $KEY_MAX;
                if [ $? == "0" ]; then
                  break;
                fi
              done;
              break;;                                                                                                     
      [Nn]* ) break;;  
      * ) echo "Please answer yes[y] or no[n]";;               
    esac 
    done
fi

  # DISPLAY PROPOSED CONFIGURATION
  echo -e "\n\nCONFIGURATION

  NODE SETTINGS
  Hostname:          "$HOSTNAME"


  MESH SETTINGS
  SSID:              "$MESH_NAME"
  Channel:           "$CHANNEL""
  
if [ $MESH_PASSWORD ]; then
  echo -e "  Encryption:        yes"
  echo -e "  Password:          "$MESH_PASSWORD""
else
  echo -e "  Encryption:        no"
fi

if [ $AP_NAME ]; then
  echo -e "\n
  ACCESS POINT SETTINGS
  SSID:              "$AP_NAME"
  Channel:           "$CHANNEL""

  if [ $AP_PASSWORD ]; then
    echo -e "  Encryption:        yes"
    echo -e "  Password:          "$AP_PASSWORD""
  else
    echo -e "  Encryption:        no"
  fi
  
fi

# save or reset configuration
while true; do
echo -e "\n\nKeep this configuration? [y/n]"
    read answer
    case $answer in                                            
        [Yy]* ) return 0;;                                                                                             
        [Nn]* ) echo "Reverting configuration settings."; 
                clear_values;
                return 1;;                                         
        * )     echo "Please answer yes[y] or no[n]";;               
    esac 
  done
}


set_config() {

# SET MESH UCI VALUES

# wireless settings
MESH_CONFIG=`uci add wireless wifi-iface`
uci rename wireless."$MESH_CONFIG"=commotionMesh

uci set wireless.commotionMesh.mode=adhoc
uci set wireless.commotionMesh.device=radio0
uci set wireless.commotionMesh.ssid="$MESH_NAME"
uci set wireless.commotionMesh.network="$MESH_NAME"
uci set wireless.radio0.channel="$CHANNEL"
uci set wireless.radio0.disabled=0

# network settings
uci set network."$MESH_NAME"=interface
uci set network."$MESH_NAME".class=mesh
uci set network."$MESH_NAME".profile="$MESH_NAME"
uci set network."$MESH_NAME".proto=commotion

# firewall settings
uci add_list firewall.@zone[1].network="$MESH_NAME"


# set Commotion profile settings
commotion new "$MESH_NAME"
commotion set "$MESH_NAME" ssid "$MESH_NAME"
commotion set "$MESH_NAME" channel "$CHANNEL"

#set encryption settings
if [ $MESH_PASSWORD ]; then
  commotion set "$MESH_NAME" key "$MESH_PASSWORD"; 
  uci set wireless.commotionMesh.encryption=psk2;
  uci set wireless.commotionMesh.key="$MESH_PASSWORD";
else
  commotion set "$MESH_NAME" encryption none
  uci set wireless.commotionMesh.encryption=none
fi


# SET AP SETTINGS
if [ $AP_NAME ]; then
  # set AP uci values
  AP_CONFIG=`uci add wireless wifi-iface`
  uci rename wireless."$AP_CONFIG"=commotionAP

  uci set wireless.commotionAP.network=lan
  uci set wireless.commotionAP.mode=ap
  uci set wireless.commotionAP.ssid="$AP_NAME"
  uci set wireless.commotionAP.device=radio0
  
  # set AP encryption
  if [ $AP_PASSWORD ]; then
    uci set wireless.commotionAP.encryption=psk2;
    uci set wireless.commotionAP.key="$AP_PASSWORD";
  else
    uci set wireless.commotionAP.encryption=none
  fi
fi

  
# mark changes in setup_wizard config file
uci set setup_wizard.settings.enabled=0
uci commit setup_wizard

# commit Commotion profile changes
commotion save "$MESH_NAME"

# commit uci changes
uci commit wireless
uci commit network
uci commit system
uci commit firewall

echo -e "\n\nSettings saved."

echo -e "\n\nRestarting networking.\n\n"

# restart networking
/etc/init.d/commotiond restart
/etc/init.d/network reload
}


# SCRIPT BEGINS HERE
if [ `uci get setup_wizard.settings.enabled` == 0 ]; then
  echo -e "Setup Wizard has already been run."
while true; do
echo -e "\n\nSet new configuration? [y/n]"
    read answer
    case $answer in                                            
        [Yy]* ) echo -e "Reverting previous configuration.";
                clear_previous_configuration;
                break;;                                                                                              
        [Nn]* ) echo -e "Keeping settings. Closing Setup Wizard."; 
                exit 0;;                                          
        * )     echo "Please answer yes[y] or no[n]";;               
    esac 
  done
fi


# RUN SETUP WIZARD
get_config 

# if user rejects settings, rerun get_config
while [ $? -eq 1 ]; do                                                                                                                                
  get_config                                                                                                                                                                                                                                                                                                                                  
done 

# if user accepts settings, run set_config
if [ $? -eq 0 ]; then
  set_config
fi