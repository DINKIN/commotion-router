#!/bin/ash

echo -e "\n\nWelcome to the configuration wizard.\n"

# if password not set, require password set
if [ `grep root /etc/shadow | cut -d ":" -f 2` == "x" ]; then
  echo "Please choose an administrator password: "
  passwd
fi

# if hostname not changed, allow option to set hostname
if [ !`grep -q \'commotion\' /etc/config/system` ]; then
  while true; do
    echo -e "Set the hostname for this device?"
    read answer
    case $answer in                                            
      [Yy]*  ) echo "Enter new hostname: ";  
            read HOSTNAME;                                
            uci set system.@system[0].hostname=$HOSTNAME;
            break;;                                                                                              
      [Nn]* ) break;;                                          
      * ) echo "Please answer yes[y] or no[n]";;               
    esac 
  done
fi

echo "Please enter new Commotion profile name: "

read PROFILE_NAME

commotion new $PROFILE_NAME

echo "Please enter mesh network name: "

read MESH_NAME

echo "Please select a valid channel: "

read MESH_CHANNEL

commotion set $PROFILE_NAME ssid $MESH_NAME

commotion set $PROFILE_NAME channel $MESH_CHANNEL

# write changes to uci
WIRELESS_CONFIG=`uci add wireless wifi-iface`
uci rename wireless.$WIRELESS_CONFIG=commotionMesh

echo "Does this mesh network use encryption?"
  read answer                                                
  case $answer in                                            
    [Yy]*  ) echo "Please choose an encryption password: ";  
          read MESH_PASSWORD;                                
          commotion set $PROFILE_NAME key $MESH_PASSWORD; 
          uci set wireless.commotionMesh.encryption=psk2;
          uci set wireless.commotionMesh.key=$MESH_PASSWORD;
          break;;                                            
                                                             
    [Nn]* ) break;;                                          
    * ) echo "Please answer yes[y] or no[n]";;               
  esac 

# set wireless config
uci set wireless.commotionMesh.mode=adhoc
uci set wireless.commotionMesh.device=radio0
uci set wireless.commotionMesh.ssid=$MESH_NAME
uci set wireless.radio0.channel=$MESH_CHANNEL
uci set wireless.radio0.disabled=0

# set network config
uci set network.$MESH_NAME=interface
uci set network.$MESH_NAME.class=mesh
uci set network.$MESH_NAME.profile=$MESH_NAME
uci set network.$MESH_NAME.proto=commotion

# set firewall



# commit profile changes
commotion save $PROFILE_NAME

# commit uci changes
uci commit wireless
uci commit network
uci commit system



<<DESIGN

echo -e "Set up an access point?"
  read answer                                                
  case $answer in                                            
    [Yy]*  ) 
          break;;                                            
                                                             
    [Nn]* ) exit 0;;
    * ) echo "Please answer yes[y] or no[n]";;               
  esac 


# Get AP name
read AP_NAME

# Create new wifi-iface and get resulting string
AP_CONFIG=`uci add wireless wifi-iface`

# Rename string to interface name
uci rename wireless.$AP_CONFIG=$AP_NAME

# Set default values
uci set wireless.$AP_NAME.network=lan
uci set wireless.$AP_NAME.mode=ap
uci set wireless.$AP_NAME.ssid=$AP_NAME
uci set wireless.$AP_NAME.device=radio0

# access point encryption

echo "Would you like to use encryption for the access point?"
  read answer                                                
  case $answer in                                            
    [Yy]*  ) echo "Please choose an encryption password for the AP: ";  
          read AP_PASSWORD;                                
             uci set wireless.$AP_NAME.encryption=psk2
             uci set wireless.$AP_NAME.key=$AP_PASSWORD
          break;;                                            
                                                             
    [Nn]* ) break;;  
            
    * ) echo "Please answer yes[y] or no[n]";;               
  esac 


# Commit changes
uci commit

DESIGN
