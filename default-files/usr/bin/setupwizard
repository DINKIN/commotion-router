#!/bin/ash

<<COMMENT

User workflow
* flash router
* telnet in
* enter password
* new profile name
* mesh network name
* channel
* mesh encryption?
--> mesh encryption password
* access point name
* channel
* require a password?
--> AP password

COMMENT


echo -e "\n\nWelcome to the configuration wizard.\n"

if [ `grep root /etc/shadow | cut -d ":" -f 2` == "x" ]; then
  echo "Please choose an administrator password: "
  passwd
fi

echo "Please enter new profile name: "

read PROFILE_NAME

commotion new $PROFILE_NAME

echo "Please enter mesh network name: "

read MESH_NAME

echo "Please select a valid channel: "

commotion set $PROFILE_NAME ssid $MESH_NAME

read MESH_CHANNEL

commotion set $PROFILE_NAME channel $MESH_CHANNEL

# generate bssid
BSSID=`commotion genbssid $MESH_NAME $MESH_CHANNEL`

# write changes to uci
MESH_CONFIG=`uci add wireless wifi-iface`

uci rename wireless.$MESH_CONFIG=$MESH_NAME
uci set wireless.$MESH_NAME.mode=adhoc
uci set wireless.$MESH_NAME.device=radio0
uci set wireless.$MESH_NAME.network=$MESH_NAME
uci set wireless.$MESH_NAME.ssid=$MESH_NAME
uci set wireless.$MESH_NAME.bssid=$BSSID


echo "Does this mesh network use encryption?"
  read answer                                                
  case $answer in                                            
    [Yy]*  ) echo "Please choose an encryption password: ";  
          read MESH_PASSWORD;                                
          commotion set $PROFILE_NAME key $MESH_PASSWORD; 
          uci set wireless.$MESH_NAME.encryption=psk2;
          uci set wireless.$MESH_NAME.key=$MESH_PASSWORD;
          break;;                                            
                                                             
    [Nn]* ) break;;                                          
    * ) echo "Please answer yes[y] or no[n]";;               
  esac 

# commit profile changes
commotion save $PROFILE_NAME

# commit uci changes
uci commit



<<DESIGN

# Get AP name
read AP_NAME

# Create new wifi-iface and get resulting string
AP_CONFIG=`uci add wireless wifi-iface`

# Rename string to interface name
uci rename wireless.$AP_CONFIG=$AP_NAME

# Set default values
uci set wireless.$AP_NAME.network=lan
uci set wireless.$AP_NAME.mode=ap
uci set wireless.$AP_NAME.ssid=$AP_NAME
uci set wireless.$AP_NAME.device=radio0

# access point encryption

echo "Would you like to use encryption for the access point?"
  read answer                                                
  case $answer in                                            
    [Yy]*  ) echo "Please choose an encryption password for the AP: ";  
          read AP_PASSWORD;                                
             uci set wireless.$AP_NAME.encryption=psk2
             uci set wireless.$AP_NAME.key=$AP_PASSWORD
          break;;                                            
                                                             
    [Nn]* ) break;;  
            
    * ) echo "Please answer yes[y] or no[n]";;               
  esac 


# Commit changes
uci commit

DESIGN
